name: 2ï¸âƒ£ Approval & Merge to Main

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  merge:
    name: Merge to main
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"

      - name: ðŸŒ³ Prepare main branch
        run: |
          git fetch origin develop
          if ! git rev-parse --verify origin/main >/dev/null 2>&1; then
            git checkout -b main
            git push origin main
          else
            git checkout main
          fi

      - name: ðŸ”„ Merge develop â†’ main
        run: |
          git fetch origin develop
          git merge origin/develop --no-ff -m "Release approved"

      - name: ðŸ·ï¸ Create Release Tag
        id: tag
        run: |
          RELEASE_TAG="v1.0.0"
          git tag -a "${RELEASE_TAG}" -m "Release ${RELEASE_TAG}"
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Push to GitHub
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/Shakir31/my-calculator.git
          git push origin main
          git push origin ${{ steps.tag.outputs.release_tag }}
          echo "âœ… Merged and tagged!"
